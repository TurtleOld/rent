{% extends 'base.html' %}
{% load static %}

{% block title %}Статистика документов ЕПД{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-graph-up"></i> Статистика документов ЕПД
            </h1>
            <div class="btn-group">
                <a href="?days=7" class="btn btn-outline-primary {% if days == 7 %}active{% endif %}">7 дней</a>
                <a href="?days=30" class="btn btn-outline-primary {% if days == 30 %}active{% endif %}">30 дней</a>
                <a href="?days=90" class="btn btn-outline-primary {% if days == 90 %}active{% endif %}">90 дней</a>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="bi bi-file-earmark-text display-4"></i>
                        <div class="stat-number">{{ stats.total_documents }}</div>
                        <div class="stat-label">Всего документов</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center" style="background: linear-gradient(135deg, #198754, #146c43);">
                    <div class="card-body">
                        <i class="bi bi-calendar-check display-4"></i>
                        <div class="stat-number">{{ stats.recent_documents }}</div>
                        <div class="stat-label">За последние {{ days }} дней</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center" style="background: linear-gradient(135deg, #0dcaf0, #0aa2c0);">
                    <div class="card-body">
                        <i class="bi bi-currency-dollar display-4"></i>
                        <div class="stat-number">{{ stats.total_amount|floatformat:0 }} ₽</div>
                        <div class="stat-label">Общая сумма</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card text-center" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                    <div class="card-body">
                        <i class="bi bi-people display-4"></i>
                        <div class="stat-number">{{ stats.unique_accounts }}</div>
                        <div class="stat-label">Уникальных счетов</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Statistics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-calculator"></i> Финансовая статистика
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-success">{{ stats.recent_amount|floatformat:2 }} ₽</h4>
                                    <p class="text-muted">Сумма за {{ days }} дней</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-info">{{ stats.avg_amount|floatformat:2 }} ₽</h4>
                                    <p class="text-muted">Средняя сумма</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check"></i> Статистика услуг
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-warning">{{ stats.total_service_charges }}</h4>
                                    <p class="text-muted">Всего услуг</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ stats.avg_amount|floatformat:0 }}</h4>
                                    <p class="text-muted">Средняя сумма</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Services -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-trophy"></i> Топ услуг по суммам
                </h5>
            </div>
            <div class="card-body p-0">
                {% if top_services %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Услуга</th>
                                    <th class="text-center">Количество</th>
                                    <th class="text-end">Общая сумма</th>
                                    <th class="text-end">Средняя сумма</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in top_services %}
                                <tr>
                                    <td>
                                        <strong>{{ service.service_name }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ service.count }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-success">{{ service.total_amount|floatformat:2 }} ₽</strong>
                                    </td>
                                    <td class="text-end">
                                        <span class="text-muted">{{ service.total_amount|div:service.count|floatformat:2 }} ₽</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">Данные отсутствуют</h4>
                        <p class="text-muted">Загрузите документы для отображения статистики</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Back to List -->
        <div class="mt-4">
            <a href="{% url 'epd_parser:document_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>
</div>
{% endblock %} 